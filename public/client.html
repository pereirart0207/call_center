<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Walkie-Talkie</title>
  <style>
    /* Reset b√°sico */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e1e2f, #12121b);
      color: #e0e0e0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-weight: 700;
      font-size: 2.8rem;
      margin-bottom: 20px;
      color: #82cfff;
      text-shadow: 0 0 10px #52a8ff77;
      user-select: none;
    }

    /* Contenedor general */
    #register, #app, #incoming-call {
      background: #222538;
      padding: 20px 25px;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
      margin-bottom: 25px;
    }

    /* Input y botones */
    input[type="text"] {
      width: calc(100% - 110px);
      padding: 12px 15px;
      font-size: 1rem;
      border: none;
      border-radius: 8px 0 0 8px;
      outline: none;
      color: #222;
      transition: box-shadow 0.25s ease;
    }

    input[type="text"]:focus {
      box-shadow: 0 0 8px #52a8ffaa;
    }

    button {
      background: #52a8ff;
      color: #fff;
      border: none;
      padding: 12px 18px;
      font-weight: 600;
      font-size: 1rem;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 4px 12px #52a8ff88;
      user-select: none;
    }

    button:hover:not(:disabled) {
      background-color: #3f8ede;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px #3f8edecc;
    }

    button:disabled {
      background-color: #5a5f72;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    /* Lista de usuarios */
    #users {
      margin-top: 15px;
      max-height: 230px;
      overflow-y: auto;
      border: 1px solid #444966;
      border-radius: 8px;
      background: #1a1c2a;
      padding: 8px 12px;
      box-shadow: inset 0 0 5px #111633;
    }

    .user {
      padding: 10px 14px;
      margin-bottom: 8px;
      background: #2e314d;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: #a3b1ff;
      transition: background-color 0.25s ease, color 0.25s ease;
      user-select: none;
    }

    .user:hover {
      background-color: #4169e1;
      color: #fff;
      box-shadow: 0 0 12px #4169e1cc;
    }

    /* Estado y botones colgar */
    #status {
      margin-top: 18px;
      font-style: italic;
      color: #cfd9ffcc;
      min-height: 24px;
      user-select: none;
    }

    #hangupBtn {
      margin-top: 15px;
      width: 100%;
      border-radius: 10px;
      background-color: #f44336;
      box-shadow: 0 4px 12px #f4433677;
      font-weight: 700;
      letter-spacing: 0.05em;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    #hangupBtn:hover {
      background-color: #d32f2f;
      transform: translateY(-2px);
      box-shadow: 0 6px 18px #d32f2fcc;
    }

    /* Incoming call panel */
    #incoming-call {
      display: none;
      background: #2c2f4a;
      padding: 20px 25px;
      border-radius: 12px;
      box-shadow: 0 0 15px #607d8bbb;
      text-align: center;
      user-select: none;
    }

    #callerName {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 18px;
      color: #82cfff;
      text-shadow: 0 0 6px #52a8ffcc;
    }

    #incoming-call button {
      width: 48%;
      padding: 12px 0;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 10px;
      border: none;
      margin: 0 1% 0 1%;
      cursor: pointer;
      box-shadow: 0 3px 10px #52a8ffaa;
      transition: background-color 0.25s ease, transform 0.2s ease;
    }

    #incoming-call button:first-child {
      background-color: #4caf50;
      color: white;
    }

    #incoming-call button:first-child:hover {
      background-color: #3a9b38;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px #3a9b3877;
    }

    #incoming-call button:last-child {
      background-color: #f44336;
      color: white;
    }

    #incoming-call button:last-child:hover {
      background-color: #d32f2f;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px #d32f2f77;
    }

    /* Scrollbar personalizado para #users */
    #users::-webkit-scrollbar {
      width: 8px;
    }
    #users::-webkit-scrollbar-track {
      background: #1a1c2a;
      border-radius: 8px;
    }
    #users::-webkit-scrollbar-thumb {
      background: #4169e1aa;
      border-radius: 8px;
      transition: background-color 0.25s ease;
    }
    #users::-webkit-scrollbar-thumb:hover {
      background: #4169e1cc;
    }

    /* Responsive */
    @media (max-width: 480px) {
      body {
        padding: 15px 10px;
      }
      #register, #app, #incoming-call {
        max-width: 100%;
        padding: 15px 20px;
      }
      input[type="text"] {
        width: 100%;
        border-radius: 8px;
        margin-bottom: 10px;
      }
      button {
        width: 100%;
        border-radius: 8px;
      }
      #incoming-call button {
        width: 48%;
        margin: 0 1%;
      }
    }
  </style>
</head>
<body>
  <h1>Walkie-Talkie</h1>

  <div id="register">
    <input type="text" id="username" placeholder="Tu nombre" autocomplete="off" />
    <button onclick="register()">Entrar</button>
  </div>

  <div id="app" style="display:none;">
    <h2>Usuarios conectados:</h2>
    <div id="users"></div>
    <p id="status"></p>
    <button id="hangupBtn" onclick="endCall()" style="display:none;">Colgar</button>
  </div>

  <div id="incoming-call">
    <p id="callerName"></p>
    <button onclick="acceptCall()">Aceptar</button>
    <button onclick="rejectCall()">Rechazar</button>
  </div>

  <script>
    let ws, localStream, pc;
    let myName = "";
    let targetName = "";
    let incomingSignal = null;
    let caller = "";

    function register() {
      myName = document.getElementById('username').value.trim();
      if (!myName) return alert("Pon un nombre");

      // Cambiado a wss y tu URL en Render
      ws = new WebSocket(`wss://call-center-zhwp.onrender.com`);
      ws.onopen = () => {
        ws.send(JSON.stringify({ type: 'register', name: myName }));
      };

      ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'error') {
          alert(data.message);
        } else if (data.type === 'userlist') {
          updateUserList(data.users);
        } else if (data.type === 'signal') {
          await handleSignal(data);
        }
      };

      document.getElementById('register').style.display = 'none';
      document.getElementById('app').style.display = 'block';
    }

    function updateUserList(users) {
      const container = document.getElementById('users');
      container.innerHTML = '';
      users
        .filter(u => u !== myName)
        .forEach(user => {
          const div = document.createElement('div');
          div.className = 'user';
          div.textContent = user;
          div.onclick = () => startCall(user);
          container.appendChild(div);
        });
    }

    async function startCall(user) {
      targetName = user;
      document.getElementById('status').textContent = `Llamando a ${user}...`;

      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      pc = createPeerConnection();

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      ws.send(JSON.stringify({
        type: 'signal',
        to: targetName,
        signal: { type: 'offer', sdp: offer.sdp }
      }));
    }

    async function handleSignal({ from, signal }) {
      if (signal.type === 'offer') {
        caller = from;
        incomingSignal = signal;
        document.getElementById('callerName').textContent = `Llamada entrante de ${from}`;
        document.getElementById('incoming-call').style.display = 'block';
      }

      if (signal.type === 'answer') {
        await pc.setRemoteDescription(new RTCSessionDescription(signal));
        document.getElementById('status').textContent = `Conectado con ${from}`;
        document.getElementById('hangupBtn').style.display = 'inline';
      }

      if (signal.candidate && pc) {
        await pc.addIceCandidate(signal.candidate);
      }
    }

    async function acceptCall() {
      document.getElementById('incoming-call').style.display = 'none';
      targetName = caller;
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      pc = createPeerConnection();

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      await pc.setRemoteDescription(new RTCSessionDescription(incomingSignal));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      ws.send(JSON.stringify({
        type: 'signal',
        to: caller,
        signal: { type: 'answer', sdp: answer.sdp }
      }));

      document.getElementById('status').textContent = `Conectado con ${caller}`;
      document.getElementById('hangupBtn').style.display = 'inline';
      caller = "";
      incomingSignal = null;
    }

    function rejectCall() {
      document.getElementById('incoming-call').style.display = 'none';
      document.getElementById('status').textContent = `Llamada de ${caller} rechazada`;
      caller = "";
      incomingSignal = null;
    }

    function createPeerConnection() {
      const pc = new RTCPeerConnection();

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({
            type: 'signal',
            to: targetName,
            signal: { candidate: event.candidate }
          }));
        }
      };

      pc.ontrack = (event) => {
        const remoteAudio = new Audio();
        remoteAudio.srcObject = event.streams[0];
        remoteAudio.play();
      };

      pc.onconnectionstatechange = () => {
        if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
          endCall();
        }
      };

      return pc;
    }

    function endCall() {
      if (pc) pc.close();
      pc = null;
      targetName = "";
      document.getElementById('status').textContent = "";
      document.getElementById('hangupBtn').style.display = 'none';
    }

    window.onbeforeunload = () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'disconnect' }));
        ws.close();
      }
    };
  </script>
</body>
</html>
